# Story 2.5: Editable Documentation with Manual Research Capabilities

> **⚠️ STORY SPLIT NOTICE**: This story was split into two separate stories based on QA review:
> - **Story 2.5a**: [Editable Documentation - Backend API](2.5a.editable-documentation-backend-api.md) ✅ **COMPLETE**
> - **Story 2.5b**: [Editable Documentation - Frontend UI](2.5b.editable-documentation-frontend-ui.md) 📋 **TO DO**
>
> **Reason for Split**: Backend implementation (25% of work) completed with excellent quality. Frontend implementation (75% of work) not started. Natural boundary allows backend to be marked complete while frontend work continues in separate story.
>
> **QA Recommendation**: See [QA Results](#qa-results) section below for detailed rationale.

## Status
Split into 2.5a (Done) and 2.5b (Draft)

## Story
**As a** penetration tester,
**I want** fully editable markdown documentation with manual research note integration,
**so that** I can enhance automated findings with my own analysis and maintain complete control over documentation.

## Acceptance Criteria

1. In-line markdown editing capabilities for all generated documentation sections
2. Manual research notes can be added to any host, service, or vulnerability finding
3. User-added content clearly distinguished from automated research results
4. Version control for documentation changes with rollback capabilities
5. Rich text editor supports markdown syntax with live preview
6. Manual research templates for common investigation patterns and methodologies
7. Export capabilities preserve both automated and manual research contributions

## Tasks / Subtasks

- [x] **Task 1: Design and implement documentation storage model** (AC: 2, 3, 4)
  - [x] Create DocumentationSection model for storing editable content
  - [x] Create DocumentationVersion model for version history
  - [x] Add source_type field to distinguish automated vs manual content ('automated' | 'manual' | 'mixed')
  - [x] Implement database schema with PostgreSQL/SQLite support
  - [x] Create migration script for new tables
  - [x] Write unit tests for model validation and constraints

- [x] **Task 2: Extend backend API for documentation CRUD operations** (AC: 1, 2, 4)
  - [x] Create documentation API endpoints:
    - `GET /api/v1/documentation/{entity_type}/{entity_id}` - Get documentation for specific entity
    - `POST /api/v1/documentation` - Create documentation section
    - `PUT /api/v1/documentation/{entity_type}/{entity_id}` - Update documentation section
    - `POST /api/v1/documentation/{entity_type}/{entity_id}/notes` - Add manual research note
    - `GET /api/v1/documentation/sections/{doc_id}/versions` - Get version history
    - `POST /api/v1/documentation/sections/{doc_id}/rollback/{version_id}` - Rollback to previous version
  - [x] Implement Documentation repositories for data access
  - [x] Add version tracking on every update (store previous content)
  - [x] Integrate with existing Note model for backward compatibility
  - [x] Write API integration tests with pytest

- [ ] **Task 3: Build frontend markdown editor component** (AC: 1, 5)
  - [ ] Research and select React markdown editor library (e.g., @uiw/react-md-editor, react-markdown-editor-lite)
  - [ ] Create MarkdownEditor.tsx component with live preview
  - [ ] Implement syntax highlighting for markdown
  - [ ] Add toolbar for common markdown operations (bold, italic, headers, lists, code blocks)
  - [ ] Support image/file upload integration
  - [ ] Add auto-save functionality with debouncing
  - [ ] Write component tests with @testing-library/react

- [ ] **Task 4: Build documentation management UI** (AC: 1, 2, 3, 4)
  - [ ] Create DocumentationView.tsx component displaying current documentation
  - [ ] Add edit mode toggle for switching between view and edit states
  - [ ] Implement visual distinction for automated vs manual content (badges, colors, icons)
  - [ ] Create VersionHistory.tsx component showing past versions with timestamps
  - [ ] Add rollback UI with confirmation dialog
  - [ ] Integrate with RightPanel for contextual documentation display
  - [ ] Add loading states and error handling
  - [ ] Write UI interaction tests

- [ ] **Task 5: Implement manual research templates** (AC: 6)
  - [ ] Create ResearchTemplate model for storing templates
  - [ ] Define default templates for common investigation patterns:
    - Service vulnerability assessment template
    - Host reconnaissance template
    - Exploitation attempt documentation template
    - Post-exploitation findings template
  - [ ] Build template selection UI in editor toolbar
  - [ ] Implement template insertion logic (fills editor with template content)
  - [ ] Add API endpoint for managing custom templates: `GET/POST/PUT/DELETE /api/v1/templates`
  - [ ] Write tests for template functionality

- [ ] **Task 6: Extend export functionality** (AC: 7)
  - [ ] Modify existing DocumentationService to include manual research content
  - [ ] Update markdown templates to clearly indicate manual vs automated sections
  - [ ] Ensure PDF export preserves manual/automated distinction styling
  - [ ] Update JSON export to include source_type metadata
  - [ ] Add version information to exports (which version was exported)
  - [ ] Test export with mixed automated/manual content
  - [ ] Write export integration tests

- [ ] **Task 7: Add state management for documentation features** (AC: 1, 4, 5)
  - [ ] Create documentationStore.ts using Zustand for client-side state
  - [ ] Implement useDocumentation hook for fetching/updating documentation
  - [ ] Add React Query caching for documentation data
  - [ ] Implement optimistic updates for better UX
  - [ ] Add WebSocket integration for real-time update notifications (optional for MVP)
  - [ ] Write tests for state management logic

- [ ] **Task 8: Integration testing and polish** (All ACs)
  - [ ] Test complete workflow: view documentation → edit → save → verify version history → rollback
  - [ ] Test adding manual notes to hosts, services, vulnerabilities
  - [ ] Verify visual distinction between automated and manual content
  - [ ] Test template insertion and customization
  - [ ] Test export with manual content preservation
  - [ ] Verify markdown preview accuracy
  - [ ] Performance test with large documentation (>10,000 lines)
  - [ ] Cross-browser testing (Chrome, Firefox, Safari)

## Dev Notes

### Previous Story Insights

**From Story 1.4: Basic Markdown Documentation Generator**
[Source: docs/stories/1.4.basic-markdown-documentation-generator.md]

Story 1.4 implemented the foundation for markdown documentation generation:
- **DocumentationService** exists at `backend/services/documentation.py`
- Uses Jinja2 templates stored in `backend/templates/`
- Generates markdown with GitHub-flavored syntax
- Supports export to markdown, PDF (via weasyprint), JSON, CSV
- Background job processing with ExportJob model
- Template structure includes: Executive Summary, Network Overview, Host Details, Service Details, Vulnerability Summary

**Key Technical Decisions from Story 1.4:**
- Python markdown library for rendering
- Weasyprint for PDF generation
- Template-based approach allows customization
- Export API returns 202 Accepted with job tracking

**Story 2.5 Extension Strategy:**
- **Extend** existing DocumentationService to support editable sections
- **Integrate** with existing Note model for backward compatibility
- **Preserve** template-based generation for automated content
- **Add** new models for versioning and source tracking

### Technology Stack

[Source: architecture/technology-stack.md]

**Frontend Technologies:**
- **Framework**: React 18+ with TypeScript 5.0+
- **CSS**: Tailwind CSS 3.0+
- **State Management**: Zustand + React Query (Latest)
- **Testing**: Jest + React Testing Library

**Backend Technologies:**
- **Framework**: FastAPI 0.104+ with async support
- **Database**: PostgreSQL 15+ (Production) / SQLite 3.35+ (Development)
- **ORM**: SQLAlchemy 2.0+
- **Background Jobs**: Celery 5.3+ with Redis

**Markdown Editor Library Selection:**
No specific library mandated in architecture. Recommended options:
- `@uiw/react-md-editor` - Lightweight, TypeScript support, live preview
- `react-markdown-editor-lite` - Feature-rich, good documentation
- `react-mde` - Simple, proven in production

**Version Control Approach:**
No specific strategy defined. Recommended approach:
- Store previous versions in `documentation_versions` table
- Include: version_number, content, changed_by, changed_at
- Keep last 50 versions per document (configurable)
- Use PostgreSQL JSONB for efficient storage

### Data Models

[Source: architecture/data-models.md]

**Existing Models Relevant to Story 2.5:**

**Host Model:**
```typescript
interface Host {
  id: string;
  project_id: string;
  ip_address: string;
  hostname?: string;
  os_family?: string;
  os_details?: string;
  status: 'up' | 'down' | 'filtered';
  confidence_score?: number;
  metadata: HostMetadata;
}
```

**Service Model:**
```typescript
interface Service {
  id: string;
  host_id: string;
  port: number;
  protocol: 'tcp' | 'udp';
  service_name?: string;
  product?: string;
  version?: string;
  banner?: string;
  confidence: 'high' | 'medium' | 'low';
}
```

**Vulnerability Model:**
```typescript
interface Vulnerability {
  id: string;
  cve_id?: string;
  cvss_score?: number;
  severity: 'critical' | 'high' | 'medium' | 'low' | 'info';
  description: string;
  remediation?: string;
  exploit_available: boolean;
  references: Reference[];
}
```

**Existing Note Model:**
```typescript
interface Note {
  id: string;
  project_id: string;
  entity_type: 'host' | 'service' | 'vulnerability';
  entity_id: string;
  content: string;  // Markdown text
  author?: string;
  tags: string[];
  created_at: Date;
  updated_at: Date;
}
```

**New Models Needed for Story 2.5:**

**DocumentationSection Model (NEW):**
```typescript
interface DocumentationSection {
  id: string;
  project_id: string;
  entity_type: 'host' | 'service' | 'vulnerability' | 'project';
  entity_id: string;
  section_name: string;  // e.g., "executive_summary", "vulnerability_analysis"
  content: string;  // Markdown content
  source_type: 'automated' | 'manual' | 'mixed';
  template_id?: string;  // Reference to template used
  version: number;
  created_by?: string;
  created_at: Date;
  updated_at: Date;
}
```

**DocumentationVersion Model (NEW):**
```typescript
interface DocumentationVersion {
  id: string;
  documentation_section_id: string;
  version: number;
  content: string;  // Markdown content at this version
  source_type: 'automated' | 'manual' | 'mixed';
  changed_by?: string;
  change_description?: string;
  created_at: Date;
}
```

**ResearchTemplate Model (NEW):**
```typescript
interface ResearchTemplate {
  id: string;
  name: string;
  category: 'host' | 'service' | 'vulnerability' | 'general';
  description: string;
  template_content: string;  // Markdown template with placeholders
  is_system: boolean;  // System templates vs user-created
  created_by?: string;
  created_at: Date;
  updated_at: Date;
}
```

### Database Schema

[Source: architecture/database-schema.md]

**Existing Notes Table:**
```sql
CREATE TABLE notes (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    entity_type VARCHAR(50) NOT NULL,
    entity_id UUID NOT NULL,
    content TEXT NOT NULL,
    author VARCHAR(255),
    tags JSONB DEFAULT '[]',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notes_entity ON notes(entity_type, entity_id);
```

**New Tables for Story 2.5:**

**documentation_sections Table (NEW):**
```sql
CREATE TABLE documentation_sections (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    entity_type VARCHAR(50) NOT NULL,
    entity_id UUID NOT NULL,
    section_name VARCHAR(100) NOT NULL,
    content TEXT NOT NULL,
    source_type VARCHAR(20) NOT NULL CHECK (source_type IN ('automated', 'manual', 'mixed')),
    template_id UUID REFERENCES research_templates(id) ON DELETE SET NULL,
    version INTEGER NOT NULL DEFAULT 1,
    created_by VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(entity_type, entity_id, section_name)
);

CREATE INDEX idx_doc_sections_entity ON documentation_sections(entity_type, entity_id);
CREATE INDEX idx_doc_sections_project ON documentation_sections(project_id);

CREATE TRIGGER update_doc_sections_updated_at BEFORE UPDATE ON documentation_sections
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

**documentation_versions Table (NEW):**
```sql
CREATE TABLE documentation_versions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    documentation_section_id UUID REFERENCES documentation_sections(id) ON DELETE CASCADE,
    version INTEGER NOT NULL,
    content TEXT NOT NULL,
    source_type VARCHAR(20) NOT NULL,
    changed_by VARCHAR(255),
    change_description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(documentation_section_id, version)
);

CREATE INDEX idx_doc_versions_section ON documentation_versions(documentation_section_id, version DESC);
```

**research_templates Table (NEW):**
```sql
CREATE TABLE research_templates (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    category VARCHAR(50) NOT NULL,
    description TEXT,
    template_content TEXT NOT NULL,
    is_system BOOLEAN DEFAULT FALSE,
    created_by VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_templates_category ON research_templates(category);

CREATE TRIGGER update_templates_updated_at BEFORE UPDATE ON research_templates
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

### Frontend Architecture

[Source: architecture/frontend-architecture.md]

**Component Structure:**
```
frontend/web-app/src/
├── components/
│   ├── documentation/        # NEW for Story 2.5
│   │   ├── MarkdownEditor.tsx
│   │   ├── DocumentationView.tsx
│   │   ├── VersionHistory.tsx
│   │   ├── TemplateSelector.tsx
│   │   └── SourceTypeBadge.tsx
│   ├── layout/
│   │   ├── ThreePanelLayout.tsx
│   │   ├── RightPanel.tsx    # Integrate DocumentationView here
│   │   └── ...
│   └── common/
├── hooks/
│   └── useDocumentation.ts    # NEW
├── stores/
│   └── documentationStore.ts  # NEW
└── services/
    └── documentationApi.ts    # NEW
```

**Three-Panel Layout Integration:**
- **Left Sidebar (15%)**: Navigation to entities with documentation
- **Center Panel (60%)**: Main content (network graph, tables)
- **Right Panel (25%)**: DocumentationView component for selected entity

**State Management Pattern:**
```typescript
// documentationStore.ts
import create from 'zustand';

interface DocumentationStore {
  currentDoc: DocumentationSection | null;
  versions: DocumentationVersion[];
  isEditing: boolean;
  setCurrentDoc: (doc: DocumentationSection) => void;
  toggleEditMode: () => void;
  // ... other methods
}

export const useDocumentationStore = create<DocumentationStore>((set) => ({...}));
```

**React Query Integration:**
```typescript
// useDocumentation.ts
import { useQuery, useMutation } from 'react-query';

export const useDocumentation = (entityType: string, entityId: string) => {
  const { data, isLoading } = useQuery(
    ['documentation', entityType, entityId],
    () => documentationApi.getDocumentation(entityType, entityId)
  );

  const updateMutation = useMutation(
    (content: string) => documentationApi.updateDocumentation(entityType, entityId, content),
    {
      onSuccess: () => queryClient.invalidateQueries(['documentation']),
    }
  );

  return { documentation: data, isLoading, updateDocumentation: updateMutation.mutate };
};
```

### API Specifications

[Source: architecture/api-specification.md, stories/1.4.basic-markdown-documentation-generator.md]

**Existing Export API:**
```yaml
POST /api/v1/projects/{project_id}/export
  RequestBody:
    format: 'markdown' | 'pdf' | 'json' | 'csv'
  Response: 202 Accepted
    { id: UUID, status: 'pending', format: string }

GET /api/v1/export/{export_id}/status
  Response: 200 OK
    { status: 'pending' | 'completed' | 'failed', file_path: string }

GET /api/v1/export/{export_id}/download
  Response: 200 OK (file stream)
```

**New API Endpoints for Story 2.5:**

```yaml
# Get documentation for specific entity
GET /api/v1/documentation/{entity_type}/{entity_id}
  Parameters:
    entity_type: 'host' | 'service' | 'vulnerability' | 'project'
    entity_id: UUID
  Response: 200 OK
    {
      sections: DocumentationSection[],
      entity_type: string,
      entity_id: string
    }

# Update documentation section
PUT /api/v1/documentation/{entity_type}/{entity_id}
  RequestBody:
    {
      section_name: string,
      content: string,
      source_type: 'automated' | 'manual' | 'mixed',
      change_description?: string
    }
  Response: 200 OK
    DocumentationSection with incremented version

# Add manual research note
POST /api/v1/documentation/{entity_type}/{entity_id}/notes
  RequestBody:
    {
      content: string,
      template_id?: UUID
    }
  Response: 201 Created
    DocumentationSection (source_type: 'manual')

# Get version history
GET /api/v1/documentation/{doc_section_id}/versions
  Response: 200 OK
    DocumentationVersion[]

# Rollback to previous version
POST /api/v1/documentation/{doc_section_id}/rollback/{version_id}
  Response: 200 OK
    DocumentationSection with rolled-back content

# Template management
GET /api/v1/templates?category={category}
  Response: 200 OK
    ResearchTemplate[]

POST /api/v1/templates
  RequestBody: ResearchTemplate
  Response: 201 Created

PUT /api/v1/templates/{template_id}
  RequestBody: Partial<ResearchTemplate>
  Response: 200 OK

DELETE /api/v1/templates/{template_id}
  Response: 204 No Content
```

### Visual Distinction Strategy

**Automated vs Manual Content Display:**

Use visual indicators to distinguish content sources:

1. **Badge System:**
   - Automated: Blue badge "🤖 Automated"
   - Manual: Green badge "✏️ Manual"
   - Mixed: Purple badge "🔀 Mixed"

2. **Color Coding (Tailwind CSS):**
   ```tsx
   const sourceTypeStyles = {
     automated: 'bg-blue-50 border-blue-200',
     manual: 'bg-green-50 border-green-200',
     mixed: 'bg-purple-50 border-purple-200'
   };
   ```

3. **Section Headers:**
   - Include source type icon in section header
   - Show last updated timestamp
   - Display author name for manual sections

4. **Editor Mode:**
   - Automated sections: Display warning "Editing will change source type to 'mixed'"
   - Manual sections: No warning, editable by default
   - Mixed sections: Highlight manual additions with subtle background

### Default Research Templates

**Template 1: Service Vulnerability Assessment**
```markdown
# Service Vulnerability Assessment: {service_name}

## Service Information
- **Port**: {port}/{protocol}
- **Version**: {version}
- **Banner**: {banner}

## Vulnerability Analysis
[Add your vulnerability findings here]

## Exploitation Attempts
[Document exploitation attempts and results]

## Recommendations
[List remediation steps]
```

**Template 2: Host Reconnaissance**
```markdown
# Host Reconnaissance: {hostname} ({ip_address})

## Discovery Phase
[Document how host was discovered]

## Operating System Analysis
[Add OS fingerprinting results]

## Running Services
[List discovered services and their analysis]

## Security Posture
[Assess overall security posture]
```

**Template 3: Exploitation Documentation**
```markdown
# Exploitation Documentation

## Vulnerability Exploited
- **CVE ID**:
- **CVSS Score**:

## Exploitation Steps
1. [Step 1]
2. [Step 2]

## Proof of Concept
```code
[Add code or commands used]
```

## Impact
[Describe achieved access level and potential impact]

## Recommendations
[Mitigation steps]
```

**Template 4: Post-Exploitation Findings**
```markdown
# Post-Exploitation Findings: {hostname}

## Access Obtained
- **Level**: [user/admin/root]
- **Method**: [exploit/credential/misconfiguration]

## Lateral Movement
[Document lateral movement attempts]

## Data Accessed
[List sensitive data discovered]

## Persistence Mechanisms
[Document persistence attempts]

## Cleanup Actions
[List cleanup steps performed]
```

### File Locations

[Source: architecture/high-level-architecture.md, stories/1.4.basic-markdown-documentation-generator.md]

**Backend Files:**
- **Models**: `backend/models/documentation.py` (extend existing or create new)
- **API Routes**: `backend/api/documentation.py` (NEW)
- **Services**: `backend/services/documentation/` (extend existing service)
  - `backend/services/documentation/editor.py` (NEW - editable docs logic)
  - `backend/services/documentation/versioning.py` (NEW - version control)
  - `backend/services/documentation/templates.py` (NEW - template management)
- **Repositories**: `backend/repositories/documentation_repository.py` (NEW)
- **Migrations**: `backend/migrations/` (add new migration for tables)
- **Tests**:
  - `backend/tests/test_documentation_api.py` (NEW)
  - `backend/tests/test_documentation_service.py` (NEW)
  - `backend/tests/test_versioning.py` (NEW)

**Frontend Files:**
- **Components**: `frontend/web-app/src/components/documentation/` (NEW directory)
  - `MarkdownEditor.tsx`
  - `DocumentationView.tsx`
  - `VersionHistory.tsx`
  - `TemplateSelector.tsx`
  - `SourceTypeBadge.tsx`
- **Hooks**: `frontend/web-app/src/hooks/useDocumentation.ts` (NEW)
- **State**: `frontend/web-app/src/stores/documentationStore.ts` (NEW)
- **Services**: `frontend/web-app/src/services/documentationApi.ts` (NEW)
- **Tests**:
  - `frontend/web-app/tests/components/documentation/` (NEW directory)
  - Individual test files for each component

**Templates:**
- **System Templates**: `backend/templates/research/` (NEW directory)
  - `service_vulnerability_assessment.md`
  - `host_reconnaissance.md`
  - `exploitation_documentation.md`
  - `post_exploitation_findings.md`

### Integration with Existing Export System

[Source: stories/1.4.basic-markdown-documentation-generator.md]

**Modify DocumentationService.generate_markdown():**
```python
def generate_markdown(self, project_id: str) -> str:
    # Existing automated content generation
    automated_content = self.markdown_template.render(...)

    # NEW: Fetch and merge manual documentation sections
    manual_sections = self.documentation_repo.get_manual_sections(project_id)

    # NEW: Merge automated and manual content
    merged_content = self._merge_documentation(automated_content, manual_sections)

    return merged_content

def _merge_documentation(self, automated: str, manual: List[DocumentationSection]) -> str:
    # Insert manual sections at appropriate locations
    # Mark sections with source type indicators
    # Preserve markdown structure
    pass
```

**Export Format Enhancements:**
- Markdown: Add section headers indicating source type
- PDF: Style manual sections differently (border, background color)
- JSON: Include source_type metadata in structure
- CSV: Add source_type column

## Testing

[Source: architecture/testing-strategy.md]

### Test File Locations
- **Backend API Tests**: `backend/tests/test_documentation_api.py`
- **Backend Service Tests**: `backend/tests/test_documentation_service.py`
- **Versioning Tests**: `backend/tests/test_versioning.py`
- **Template Tests**: `backend/tests/test_templates.py`
- **Frontend Component Tests**: `frontend/web-app/tests/components/documentation/`
- **Integration Tests**: `backend/tests/integration/test_documentation_workflow.py`

### Testing Framework
- **Backend**: pytest with async support (pytest-asyncio)
- **Frontend**: Jest + React Testing Library
- **API Testing**: FastAPI TestClient (httpx)
- **Database**: pytest fixtures with transaction rollback

### Required Test Coverage

**Backend Unit Tests:**
1. **Model Validation Tests:**
   - Test DocumentationSection model constraints
   - Test DocumentationVersion uniqueness
   - Test source_type enum validation
   - Test template model validation

2. **Service Logic Tests:**
   - Test version creation on update
   - Test rollback functionality
   - Test merge logic for automated + manual content
   - Test template insertion logic

3. **API Endpoint Tests:**
   - Test GET documentation returns correct sections
   - Test PUT creates new version
   - Test POST creates manual note with correct source_type
   - Test rollback endpoint restores previous content
   - Test template CRUD operations
   - Test authentication/authorization (if applicable)

**Frontend Component Tests:**
1. **MarkdownEditor Tests:**
   - Test editor renders markdown input
   - Test live preview updates on input change
   - Test toolbar actions (bold, italic, headers)
   - Test auto-save debouncing
   - Test image upload integration

2. **DocumentationView Tests:**
   - Test displays documentation content
   - Test edit mode toggle
   - Test source type badge rendering
   - Test version history display

3. **Integration Tests:**
   - Test complete edit workflow: load → edit → save → verify version
   - Test template insertion into editor
   - Test rollback updates UI correctly

**Integration/E2E Tests:**
1. **Complete Workflow Test:**
   ```python
   def test_documentation_edit_workflow():
       # Create project with automated documentation
       project = create_project_with_scan_data()

       # Fetch documentation for a host
       response = client.get(f"/api/v1/documentation/host/{host_id}")
       assert response.status_code == 200
       assert response.json()["sections"][0]["source_type"] == "automated"

       # Update section with manual content
       response = client.put(
           f"/api/v1/documentation/host/{host_id}",
           json={"section_name": "executive_summary", "content": "Manual findings..."}
       )
       assert response.json()["version"] == 2
       assert response.json()["source_type"] == "mixed"

       # Verify version history
       response = client.get(f"/api/v1/documentation/{doc_id}/versions")
       assert len(response.json()) == 2

       # Rollback to version 1
       response = client.post(f"/api/v1/documentation/{doc_id}/rollback/{version_1_id}")
       assert response.json()["source_type"] == "automated"
   ```

2. **Template Workflow Test:**
   ```python
   def test_research_template_workflow():
       # Create template
       response = client.post("/api/v1/templates", json={
           "name": "Custom Assessment",
           "category": "service",
           "template_content": "# Assessment\n\n{service_name}"
       })
       template_id = response.json()["id"]

       # Use template in note creation
       response = client.post(
           f"/api/v1/documentation/service/{service_id}/notes",
           json={"content": "", "template_id": template_id}
       )
       assert "Assessment" in response.json()["content"]
   ```

3. **Export Preservation Test:**
   ```python
   def test_export_preserves_manual_content():
       # Add manual content to documentation
       add_manual_note(host_id, "Manual findings here")

       # Export as markdown
       export_job = trigger_export(project_id, format="markdown")
       wait_for_completion(export_job.id)

       # Download and verify manual content included
       content = download_export(export_job.id)
       assert "Manual findings here" in content
       assert "✏️ Manual" in content or "Manual" in content
   ```

### Performance Test Requirements
- Documentation load time <500ms for typical project (50 hosts, 200 services)
- Editor response time <100ms for documents up to 10,000 lines
- Version history retrieval <200ms for 50 versions
- Export with manual content <30 seconds for large project

### Edge Cases to Test
- Empty documentation sections
- Very large markdown content (>100,000 characters)
- Rapid successive edits (concurrency)
- Rollback to non-existent version
- Template with missing placeholder values
- Special characters in markdown content
- Malformed markdown syntax
- Cross-site scripting prevention in editor

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-30 | 1.0 | Initial story creation for Epic 2: Editable Documentation with Manual Research Capabilities | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4.5 (claude-sonnet-4-5-20250929)

### File List
**Backend Models:**
- `backend/models/documentation.py` - New documentation models (DocumentationSection, DocumentationVersion, ResearchTemplate)
- `backend/models/__init__.py` - Updated to export new documentation models

**Backend Repositories:**
- `backend/repositories/documentation_repository.py` - Data access layer for documentation (DocumentationSectionRepository, DocumentationVersionRepository, ResearchTemplateRepository)

**Backend API:**
- `backend/api/documentation.py` - API endpoints for documentation CRUD operations
- `backend/api/schemas.py` - Pydantic schemas for documentation requests/responses
- `backend/main.py` - Updated to include documentation router

**Database:**
- `backend/alembic/versions/c8d3e4f5a6b7_add_documentation_tables.py` - Migration for documentation tables

**Tests:**
- `backend/tests/test_documentation_models.py` - Unit tests for documentation models (12 tests, all passing)
- `backend/tests/test_documentation_api.py` - API integration tests (16 tests, all passing)

### Change Log
| Task | Files Modified | Description |
|------|----------------|-------------|
| Task 1 | backend/models/documentation.py | Created three new models: DocumentationSection, DocumentationVersion, ResearchTemplate with proper relationships and constraints |
| Task 1 | backend/alembic/versions/c8d3e4f5a6b7_add_documentation_tables.py | Created migration script with tables, indexes, and foreign key constraints |
| Task 1 | backend/tests/test_documentation_models.py | Added 12 unit tests covering model creation, constraints, relationships, and cascading deletes |
| Task 2 | backend/repositories/documentation_repository.py | Created repositories for all documentation models with specialized query methods |
| Task 2 | backend/api/documentation.py | Created complete REST API with 11 endpoints for documentation and template management |
| Task 2 | backend/api/schemas.py | Added 10 Pydantic schemas for request/response validation |
| Task 2 | backend/main.py | Registered documentation router with FastAPI application |
| Task 2 | backend/tests/test_documentation_api.py | Added 16 comprehensive API integration tests covering all endpoints |

### Debug Log References
None

### Completion Notes
**Completed Tasks:**
- Task 1: All models, migration, and unit tests completed successfully (12 tests passing)
- Task 2: Complete backend API implementation with repositories and 16 integration tests passing

**API Endpoints Implemented:**
- `POST /api/v1/documentation` - Create documentation section
- `GET /api/v1/documentation/{entity_type}/{entity_id}` - Get entity documentation
- `PUT /api/v1/documentation/{entity_type}/{entity_id}` - Update documentation with versioning
- `POST /api/v1/documentation/{entity_type}/{entity_id}/notes` - Add manual notes
- `GET /api/v1/documentation/sections/{doc_id}/versions` - Version history
- `POST /api/v1/documentation/sections/{doc_id}/rollback/{version_id}` - Rollback functionality
- `GET /api/v1/templates` - List templates (with optional category filter)
- `POST /api/v1/templates` - Create template
- `GET /api/v1/templates/{id}` - Get specific template
- `PUT /api/v1/templates/{id}` - Update template
- `DELETE /api/v1/templates/{id}` - Delete template

**Remaining Work:**
- Tasks 3-8: Frontend implementation (React components, state management, UI, integration)
- These tasks require significant frontend development work with React, TypeScript, and state management libraries

## QA Results

### Review Date: 2025-09-30

### Reviewed By: Quinn (Test Architect)

### Executive Summary

Story 2.5 represents **partial completion (25%) - backend-only implementation**. Tasks 1-2 (backend models, API, database) are complete with excellent quality. Tasks 3-8 (all frontend work) remain unstarted. The backend implementation demonstrates strong architectural decisions, comprehensive test coverage, and solid versioning logic.

**Key Strengths:**
- ✅ Robust data models with proper constraints and cascading deletes
- ✅ Complete API with 11 endpoints and proper error handling
- ✅ 28 tests (12 model + 16 API) all passing with excellent coverage
- ✅ Clean separation of concerns (models, repositories, API, schemas)
- ✅ Version control system well-implemented with rollback capability

**Critical Gap:**
- ❌ **Story marked "Ready for Review" but only 25% complete** - Frontend implementation (75% of work) not started
- ❌ No acceptance criteria can be validated without UI components

### Code Quality Assessment

**Backend Implementation: EXCELLENT (9/10)**

The backend code demonstrates professional quality with strong architectural patterns:

1. **Data Models** [backend/models/documentation.py:1-77](backend/models/documentation.py#L1-L77)
   - Clean enum definitions (SourceType, TemplateCategory)
   - Proper use of unique constraints and foreign keys
   - Well-designed relationships with cascade behaviors
   - Comprehensive docstrings

2. **Repository Pattern** [backend/repositories/documentation_repository.py:1-237](backend/repositories/documentation_repository.py#L1-L237)
   - Excellent separation of data access logic
   - Specialized query methods (get_by_entity, get_by_entity_and_section)
   - Transactional update_with_version() method
   - Complex rollback_to_version() logic handled correctly

3. **API Implementation** [backend/api/documentation.py:1-333](backend/api/documentation.py#L1-L333)
   - RESTful design with proper HTTP verbs and status codes
   - Intelligent source_type transition logic (automated → mixed when edited)
   - System template protection (cannot update/delete)
   - Proper error handling with meaningful messages

4. **Database Migration** [backend/alembic/versions/c8d3e4f5a6b7_add_documentation_tables.py:1-94](backend/alembic/versions/c8d3e4f5a6b7_add_documentation_tables.py#L1-L94)
   - Correct table creation order (templates before sections)
   - Proper indexes for query optimization
   - Supports both PostgreSQL and SQLite
   - Clean downgrade path

### Refactoring Performed

**No refactoring performed.** Backend code quality is already excellent and requires no changes.

### Compliance Check

- **Coding Standards**: ✓ **PASS** - Clean Python code, proper type hints, good naming conventions
- **Project Structure**: ✓ **PASS** - Follows established patterns (models, repositories, API, schemas)
- **Testing Strategy**: ✓ **PASS** - pytest with fixtures, unit and integration tests, excellent coverage
- **Architecture Alignment**: ✓ **PASS** - Uses FastAPI, SQLAlchemy 2.0, Pydantic schemas as specified
- **All ACs Met**: ✗ **FAIL** - Cannot validate without frontend (only 2 of 8 tasks complete)

### Requirements Traceability (Given-When-Then)

**Acceptance Criteria Coverage Analysis:**

**AC1: In-line markdown editing capabilities**
- **Status**: ❌ NOT TESTABLE (Backend ready, frontend missing)
- **Given**: User views documentation section
- **When**: User clicks edit button and modifies markdown
- **Then**: Changes are saved with version history
- **Test Coverage**: Backend API tested (PUT /documentation), but no UI tests exist

**AC2: Manual research notes can be added**
- **Status**: ❌ NOT TESTABLE (Backend ready, frontend missing)
- **Given**: User viewing a host/service/vulnerability
- **When**: User adds manual research note via API
- **Then**: Note is created with source_type='manual'
- **Test Coverage**: API endpoint tested [test_documentation_api.py:122-161](backend/tests/test_documentation_api.py#L122-L161), no UI tests

**AC3: User-added content clearly distinguished**
- **Status**: ❌ NOT TESTABLE (Backend ready, frontend missing)
- **Given**: Documentation contains both automated and manual content
- **When**: User views documentation
- **Then**: Visual distinction via badges/colors
- **Test Coverage**: source_type field exists and tested, but no visual distinction UI

**AC4: Version control with rollback**
- **Status**: ✅ BACKEND COMPLETE (Frontend missing)
- **Given**: Documentation has multiple versions
- **When**: User requests rollback to previous version
- **Then**: Content restored and new version created
- **Test Coverage**: ✅ Full backend coverage [test_documentation_api.py:154-199](backend/tests/test_documentation_api.py#L154-L199)

**AC5: Rich text editor with live preview**
- **Status**: ❌ NOT STARTED
- **Given**: User in edit mode
- **When**: User types markdown
- **Then**: Live preview updates
- **Test Coverage**: ❌ No tests (Task 3 not started)

**AC6: Manual research templates**
- **Status**: ✅ BACKEND COMPLETE (Frontend missing)
- **Given**: User wants to document service assessment
- **When**: User selects template from library
- **Then**: Template content inserted into editor
- **Test Coverage**: ✅ Template CRUD tested [test_documentation_api.py:201-360](backend/tests/test_documentation_api.py#L201-L360)

**AC7: Export preserves manual/automated content**
- **Status**: ❌ NOT STARTED (Task 6)
- **Given**: Documentation contains mixed content
- **When**: User exports to markdown/PDF
- **Then**: Source types visually distinguished in output
- **Test Coverage**: ❌ No tests

**Summary**: 2/7 ACs have backend foundation complete, 5/7 have NO implementation at all.

### Test Coverage Analysis

**Backend Tests: EXCELLENT**

**Unit Tests** [backend/tests/test_documentation_models.py](backend/tests/test_documentation_models.py):
- ✅ 12 tests covering all model behaviors
- ✅ Constraint validation (unique constraints, enum validation)
- ✅ Relationship testing (sections↔versions, sections↔templates)
- ✅ Cascade delete behavior verified
- ✅ All tests passing in 0.22s

**Integration Tests** [backend/tests/test_documentation_api.py](backend/tests/test_documentation_api.py):
- ✅ 16 tests covering all 11 API endpoints
- ✅ Happy path and error scenarios
- ✅ Version history and rollback workflows
- ✅ Template CRUD with system template protection
- ✅ All tests passing in 0.74s

**Coverage Gaps:**
- ❌ Frontend component tests (Tasks 3-4) - 0 tests
- ❌ State management tests (Task 7) - 0 tests
- ❌ Export integration tests (Task 6) - 0 tests
- ❌ End-to-end workflow tests (Task 8) - 0 tests

### Non-Functional Requirements Assessment

**Security: CONCERNS** ⚠️
- ✅ **SQL Injection**: Protected via SQLAlchemy ORM
- ⚠️ **XSS Risk**: User-generated markdown will be rendered in frontend - **REQUIRES** sanitization
- ⚠️ **Authentication**: No auth implemented on API endpoints (may be handled at gateway level)
- ⚠️ **Authorization**: No user role checks (who can edit system templates?)
- ✅ **Cascade Deletes**: Properly configured to prevent orphaned data

**Recommendation**: Before frontend implementation, establish markdown sanitization strategy (DOMPurify or similar) and authentication/authorization requirements.

**Performance: PASS** ✓
- ✅ Proper database indexes on query columns
- ✅ Pagination support (skip/limit) in repository methods
- ✅ Version history limited to 50 versions (configurable)
- ✅ Efficient queries with proper filtering
- ⚠️ **Potential Concern**: Large markdown content (>100KB) not tested for performance

**Reliability: PASS** ✓
- ✅ Comprehensive error handling in API layer
- ✅ Transactional updates ensure data consistency
- ✅ Proper HTTP status codes (404, 400, 403, 201)
- ✅ Cascade deletes prevent orphaned records
- ✅ Rollback mechanism preserves data integrity

**Maintainability: EXCELLENT** ✓
- ✅ Clean separation of concerns (models, repos, API, schemas)
- ✅ Consistent naming conventions
- ✅ Well-documented code with docstrings
- ✅ Type hints throughout
- ✅ Testable architecture with dependency injection

### Testability Evaluation

**Controllability: EXCELLENT** ✓
- ✅ Repository pattern allows easy data setup
- ✅ Dependency injection via FastAPI Depends()
- ✅ Clear input validation via Pydantic schemas

**Observability: EXCELLENT** ✓
- ✅ Rich response models with all relevant fields
- ✅ Version history provides audit trail
- ✅ Change descriptions track modifications
- ✅ Timestamps on all entities

**Debuggability: EXCELLENT** ✓
- ✅ Meaningful error messages
- ✅ Proper exception handling
- ✅ Test fixtures provide isolated environments
- ✅ Transaction rollback in tests prevents side effects

### Technical Debt Identification

**Current Debt: LOW** (for completed backend portion)

**Minor Issues:**
1. **Schema Import Organization** [backend/api/schemas.py:1-10](backend/api/schemas.py#L1-L10)
   - All schemas in single file (162+ lines currently)
   - **Impact**: Low - manageable for current size
   - **Recommendation**: Consider splitting into separate files if grows beyond 300 lines

2. **Manual Note Creation Logic** [backend/api/documentation.py:157-161](backend/api/documentation.py#L157-L161)
   - Raises error if section doesn't exist (comment says "need project_id")
   - **Impact**: Low - API design limitation documented
   - **Recommendation**: Refactor to lookup project_id from entity_id in future sprint

3. **Missing Migration Application**
   - Current head: `b9fcac715c43`, should be: `c8d3e4f5a6b7`
   - **Impact**: Medium - migration exists but not applied
   - **Action**: Run `alembic upgrade head` before deploying

**Future Debt (from incomplete work):**
- **Frontend Integration Complexity**: 6 tasks remaining will require careful state management
- **Export Integration**: Modifying existing DocumentationService may introduce regression risk

### Security Review

**Current Implementation: SECURE** ✓ (with caveats)

**Identified Concerns:**
1. **User-Generated Markdown Content**
   - **Risk**: XSS attacks when markdown rendered in browser
   - **Status**: Not addressed (frontend not implemented)
   - **Action Required**: Implement markdown sanitization before v1.0

2. **Missing Authentication/Authorization**
   - **Status**: No auth checks in API layer
   - **Assumption**: Handled at API gateway or middleware level
   - **Action Required**: Clarify auth strategy before frontend implementation

3. **System Template Protection**
   - ✅ **Mitigated**: Cannot update/delete system templates via API [documentation.py:294-298, 326-330](backend/api/documentation.py#L294-L298)

### Performance Considerations

**Current Performance: GOOD** ✓

**Optimizations Present:**
- ✅ Database indexes on frequently queried columns
- ✅ Pagination support prevents large result sets
- ✅ Efficient queries with proper joins via relationships

**Potential Optimizations:**
- Consider caching for frequently accessed templates
- Add content size limits (e.g., max 1MB per section)
- Implement lazy loading for version history

### Files Modified During Review

**No files modified.** Backend code quality is excellent and requires no changes.

### Gate Status

**Gate: CONCERNS** → [docs/qa/gates/2.5-editable-documentation.yml](docs/qa/gates/2.5-editable-documentation.yml)

**Reason**: Backend implementation is excellent quality, but story marked "Ready for Review" with only 25% completion (2/8 tasks). No acceptance criteria can be validated without frontend.

### Recommended Status

**✗ CHANGES REQUIRED**

**Critical Issues:**
1. **Story Status Mismatch**: Change status from "Ready for Review" to "In Progress" or split story
2. **Completion Criteria**: Backend-only completion does not satisfy Definition of Done
3. **Frontend Work Required**: Tasks 3-8 must be completed before re-review

**Options for Resolution:**
1. **Option A** (Recommended): Split into two stories:
   - Story 2.5a: "Editable Documentation - Backend API" (✅ COMPLETE)
   - Story 2.5b: "Editable Documentation - Frontend UI" (⏳ TO DO)

2. **Option B**: Continue with Story 2.5, complete Tasks 3-8, then request re-review

3. **Option C**: Accept backend-only completion for this sprint, defer frontend to next sprint (requires PO approval)

**Backend Quality Gate: PASS** ✅ - The completed backend work is production-ready quality.

**Story Completion Gate: FAIL** ❌ - Story cannot be marked "Done" with 75% of work remaining.

### Next Steps

1. **Immediate**: Update story status to reflect actual completion state
2. **Short-term**: Complete frontend Tasks 3-8 OR split story as suggested
3. **Before Production**: Address XSS sanitization and auth/authz strategy
4. **Before Deployment**: Apply database migration `c8d3e4f5a6b7`

---

**Review Quality**: Comprehensive adaptive review completed. Backend implementation demonstrates excellent engineering practices. Frontend implementation required before story can be accepted.